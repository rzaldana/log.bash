#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
docker_context="$repo_root/test"
supported_versions_file="$repo_root/SUPPORTED_BASH_VERSIONS"
image_tags_file="$repo_root/.image_tags"

# Cleanup image tags if present
if [[ -f "$image_tags_file" ]]; then
  rm "$image_tags_file"
fi

while IFS= read -r bash_version; do
  echo "========== building container image for bash version $bash_version =========="
  image_tag="blog_test_bash_$bash_version"
  docker build \
    --tag "$image_tag" \
    --build-arg "BASH_VERSION=$bash_version" \
    "$docker_context"
  echo "$image_tag" >> "$image_tags_file"
done < "$supported_versions_file"
